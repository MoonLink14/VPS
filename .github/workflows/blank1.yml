name: Continuous Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *'   # Restart every 6 hours
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 350

    env:
      VPS_USERNAME: "root"
      VPS_PASSWORD: "vps123456789"
      HOSTNAME: "worldcraftlink"
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Setup SSH server (Dropbear)
      - name: Setup Dropbear SSH
        run: |
          echo "root:$VPS_PASSWORD" | sudo chpasswd
          sudo mkdir -p /etc/dropbear
          sudo dropbear -r /etc/dropbear/dropbear_rsa_host_key -p 22 -E -F -w -s &
          echo "✅ Dropbear SSH enabled (root login with password)"

      # Download and run Playit (new script)
      - name: Run Playit Tunnel
        run: |
          curl -fsSL https://ptero.co/raw/oqadojaket -o playit.sh
          chmod +x playit.sh
          ./playit.sh > playit.log 2>&1 &

          # wait for Playit to boot
          sleep 15
          cat playit.log

      # Extract Claim Link
      - name: Extract Playit claim link
        id: playitclaim
        run: |
          CLAIM_LINK=$(grep -oE 'https?://[^ ]+' playit.log | grep -i 'claim' | tail -n1 || true)
          echo "CLAIM_LINK=$CLAIM_LINK" >> $GITHUB_ENV
          if [ -n "$CLAIM_LINK" ]; then
            echo "✅ Found Playit claim link: $CLAIM_LINK"
          else
            echo "⚠️ No claim link found in playit.log"
            echo "ℹ️ Dumping last 50 lines of playit.log for debugging:"
            tail -n 50 playit.log
          fi

      # Extract SSH Info
      - name: Extract SSH info
        run: |
          TUNNEL_IP=$(grep -oP '(?<=Forwarding ).*:[0-9]+' playit.log | tail -n1 | cut -d: -f1)
          TUNNEL_PORT=$(grep -oP '(?<=Forwarding ).*:[0-9]+' playit.log | tail -n1 | cut -d: -f2)
          echo "TUNNEL_IP=$TUNNEL_IP" >> $GITHUB_ENV
          echo "TUNNEL_PORT=$TUNNEL_PORT" >> $GITHUB_ENV
          echo "✅ Tunnel detected: $TUNNEL_IP:$TUNNEL_PORT"

      # Send info to Discord
      - name: Send details to Discord
        if: env.DISCORD_WEBHOOK != ''
        run: |
          MSG="✅ VPS Session Ready\n\`\`\`diff
+ Claim Link: $CLAIM_LINK
+ SSH: ssh root@$TUNNEL_IP -p $TUNNEL_PORT
+ Username: root
+ Password: $VPS_PASSWORD
\`\`\`"
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"$MSG\"}" \
               $DISCORD_WEBHOOK
